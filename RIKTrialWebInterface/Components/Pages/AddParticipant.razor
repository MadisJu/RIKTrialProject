@page "/events/{EventId:guid}/participants/add"

@using RIKTrialSharedModels.Domain.Creation
@using RIKTrialSharedModels.Domain.Types
@using RIKTrialSharedModels.Domain.Validation
@using Microsoft.AspNetCore.Components.Forms
@rendermode InteractiveServer

@inject ParticipantAPIService ParticipantApi
@inject PaymentMethodAPIService PaymentApi
@inject EventAPIService EventApi
@inject NavigationManager Nav

@implements IDisposable

<PageTitle>Lisa Osaleja</PageTitle>

<div class="Banner">
    <div class="Banner-Text Text-Header Text-Header--Center">
        <h1>Lisa osaleja üritusele</h1>
    </div>

    <div class="Banner-Image">
        <img src="/images/libled.jpg" />
    </div>
</div>

<div class="Form-Body">
    <div class="Form-Card">

        <h2>Osaleja Andmed</h2>

        <EditForm EditContext="_editContext"
                  OnValidSubmit="SubmitParticipant"
                  OnInvalidSubmit="InvalidSubmit">

            <DataAnnotationsValidator />
            <ValidationSummary />
            <div class="Form-Row">
                <label>Tüüp</label>

                <InputRadioGroup @bind-Value="_model.Type"
                                 TValue="ParticipantType"
                                 Name="ParticipantType"
                                 class="Type-Selector">

                    <label class="Type-Option">
                        <InputRadio Value="ParticipantType.PERSON" />
                        Eraisik
                    </label>

                    <label class="Type-Option">
                        <InputRadio Value="ParticipantType.COMPANY" />
                        Ettevõte
                    </label>

                </InputRadioGroup>
            </div>

            @if (_model.Type == ParticipantType.PERSON)
            {
                <div class="Form-Row">
                    <label>Eesnimi</label>
                    <InputText class="form-input" @bind-Value="_model.FirstName" />
                </div>

                <div class="Form-Row">
                    <label>Perekonnanimi</label>
                    <InputText class="form-input" @bind-Value="_model.LastName" />
                </div>

                <div class="Form-Row">
                    <label>Isikukood</label>
                    <InputText class="form-input" @bind-Value="_model.IdNumber" />
                </div>
            }

            @if (_model.Type == ParticipantType.COMPANY)
            {
                <div class="Form-Row">
                    <label>Nimi</label>
                    <InputText class="form-input" @bind-Value="_model.Name" />
                </div>

                <div class="Form-Row">
                    <label>Registrikood</label>
                    <InputText class="form-input" @bind-Value="_model.ComapnyCode" />
                </div>

                <div class="Form-Row">
                    <label>Osalejate arv</label>
                    <InputNumber class="form-input"
                                 @bind-Value="_model.ParticipantAmount" />
                </div>
            }

            <!-- Payment Method -->
            <div class="Form-Row">
                <label>Makseviis</label>

                <InputSelect class="form-input"
                             @bind-Value="_model.PaymentMethodId">
                    @foreach (PaymentMethodReturnDTO pm in _paymentMethods)
                    {
                        <option value="@pm.Id">@pm.PaymentMethod</option>
                    }
                </InputSelect>
            </div>

            <!-- Additional Info -->
            <div class="Form-Row">
                <label>Lisainfo</label>
                <InputTextArea class="form-input form-textarea"
                               @bind-Value="_model.AdditionalInfo" />
            </div>

            <!-- Buttons -->
            <div class="form-actions">
                <button type="button"
                        class="btn btn--secondary"
                        @onclick="NavigateBack">
                    Tagasi
                </button>

                <button type="submit"
                        class="btn btn--primary">
                    Lisa Osaleja
                </button>
            </div>

        </EditForm>

    </div>
</div>

@code
{
    [Parameter]
    public Guid EventId { get; set; }

    private ParticipantCreationDTO _model = new();
    private EditContext _editContext = default!;
    private ValidationMessageStore? _validationMessages;

    private List<PaymentMethodReturnDTO> _paymentMethods = new();

    protected override async Task OnInitializedAsync()
    {
        _editContext = new EditContext(_model);
        _validationMessages = new ValidationMessageStore(_editContext);
        _editContext.OnValidationRequested += OnValidateRequested;
        _editContext.OnFieldChanged += OnFieldChanged;

        _model.Type = ParticipantType.PERSON;

        _paymentMethods = await PaymentApi.GetPaymentMethods();

        if (_paymentMethods.Count == 0)
        {
            Console.WriteLine("NO PAYMENT METHODS FOUND");
            return;
        }

        _model.PaymentMethodId = _paymentMethods[0].Id;
    }

    private async Task SubmitParticipant()
    {
        RunIdValidation();
        if (!_editContext.Validate())
            return;

        Console.WriteLine("===== SUBMIT =====");
        Console.WriteLine($"Type = {_model.Type}");

        Guid participantId = await ParticipantApi.CreateParticipant(_model);

        RegistrationDTO reg = new RegistrationDTO { EventId = EventId, ParticipantId = participantId };

        bool ok =
            await EventApi.AddParticipant(reg);

        if (ok)
        {
            Nav.NavigateTo($"/events/{EventId}");
        }
    }

    private void InvalidSubmit()
    {
        Console.WriteLine("FORM INVALID — SUBMIT BLOCKED");
    }

    private void NavigateBack()
    {
        Nav.NavigateTo($"/events/{EventId}");
    }

    private void OnValidateRequested(object? sender, ValidationRequestedEventArgs e) => RunIdValidation();

    private void OnFieldChanged(object? sender, FieldChangedEventArgs e)
    {
        if (e.FieldIdentifier.FieldName is nameof(_model.IdNumber) or nameof(_model.Type))
            RunIdValidation();
    }

    private void RunIdValidation()
    {
        _validationMessages?.Clear();

        if (_model.Type == ParticipantType.PERSON)
        {
            var field = new FieldIdentifier(_model, nameof(_model.IdNumber));
            if (string.IsNullOrWhiteSpace(_model.IdNumber) || !IdCodeValidation.ValidEstonianId(_model.IdNumber))
            {
                _validationMessages?.Add(field, "Kehtetu isikukood.");
            }
        }

        _editContext.NotifyValidationStateChanged();
    }

    public void Dispose()
    {
        if (_editContext != null)
        {
            _editContext.OnValidationRequested -= OnValidateRequested;
            _editContext.OnFieldChanged -= OnFieldChanged;
        }
    }
}
