@page "/participants/{ParticipantId:guid}"
@using RIKTrialSharedModels.Domain.Updates
@using RIKTrialSharedModels.Domain.Types;
@using RIKTrialSharedModels.Transformers
@using RIKTrialWebInterface.Components.Comps

@inject ParticipantAPIService ParticipantApi
@inject PaymentMethodAPIService PaymentApi

<PageTitle>Osaleja ülevaade</PageTitle>

<Banner BannerTitle="Osaleja Andmete Muutmine"/>

<div class="Form-Body">
    @if (_participant == null || _patchData == null)
    {
        <p>Loading...</p>
    }
    else
    {
        <div class="Form-Card">
            <h2>Muuda osalejat</h2>

            <EditForm Model="_patchData" OnValidSubmit="Save">
                <DataAnnotationsValidator />
                <ValidationSummary />

                @if (_participant.Type == ParticipantType.PERSON)
                {
                    <div class="Form-Row">
                        <label>Eesnimi</label>
                        <InputText class="form-input" @bind-Value="_patchData.FirstName" />
                    </div>

                    <div class="Form-Row">
                        <label>Perekonnanimi</label>
                        <InputText class="form-input" @bind-Value="_patchData.LastName" />
                    </div>
                }
                else if (_participant.Type == ParticipantType.COMPANY)
                {
                    <div class="Form-Row">
                        <label>Ettevõtte nimi</label>
                        <InputText class="form-input" @bind-Value="_patchData.Name" />
                    </div>

                    <div class="Form-Row">
                        <label>Registrikood</label>
                        <InputText class="form-input" @bind-Value="_patchData.CompanyCode" />
                    </div>

                    <div class="Form-Row">
                        <label>Osalejate arv</label>
                        <InputNumber class="form-input" TValue="int?" @bind-Value="_patchData.ParticipantAmount" />
                    </div>
                }

                <div class="Form-Row">
                    <label>Lisainfo</label>
                    <InputTextArea class="form-input form-textarea" @bind-Value="_patchData.AdditionalInfo" />
                </div>

                <div class="Form-Row">
                    <label>Makseviis</label>
                    <InputSelect class="form-input" @bind-Value="_patchData.PaymentMethodId">
                        <option value="">-- Vali makseviis --</option>
                        @foreach (PaymentMethodReturnDTO method in _methods)
                        {
                            <option value="@method.Id">@method.PaymentMethod</option>
                        }
                    </InputSelect>
                </div>

                <div class="form-actions">
                    <button class="btn btn--primary" type="submit">Salvesta</button>
                </div>
            </EditForm>
        </div>
    }
</div>

@code 
{
    [Parameter]
    public Guid ParticipantId { get; set; }

    private bool loading = true;

    private ParticipantReturnDTO? _participant;

    private ParticipantUpdateDTO _patchData = new();

    private List<PaymentMethodReturnDTO> _methods = new();

    private bool updated = false;

    protected override async Task OnInitializedAsync()
    {
        await Init();
    }

    private async void Save()
    {

        if(_participant != null)
        {
            if (_patchData.PaymentMethodId == _participant.PaymentMethod.Id)
                _patchData.PaymentMethodId = null;

            if (_patchData.AdditionalInfo == _participant.AdditionalInfo)
                _patchData.AdditionalInfo = null;

            if (_patchData.FirstName == _participant.FirstName)
                _patchData.FirstName = null;

            if (_patchData.LastName == _participant.LastName)
                _patchData.LastName = null;
            /*
            if (_patchData.IdNumber == _participant.IdNumber)
                _patchData.IdNumber = null;
            */
            if (_patchData.Name == _participant.Name)
                _patchData.Name = null;

            if (_patchData.CompanyCode == _participant.CompanyCode)
                _patchData.CompanyCode = null;

            if (_patchData.ParticipantAmount == _participant.ParticipantAmount)
                _patchData.ParticipantAmount = null;

            updated = await ParticipantApi.UpdateParticipant(ParticipantId, _patchData);
        }

        if(updated)
        {
            await Init();
        }

    }

    private async Task Init()
    {
        _participant = await ParticipantApi.GetParticipant(ParticipantId);

        _methods = await PaymentApi.GetPaymentMethods();

        if (_participant != null)
        {
            _patchData = ParticipantDTOMapper.MapParticipantDataToCreationDTO(_participant);
        }
        
        StateHasChanged();
    }
}
